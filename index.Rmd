---
title: "fasster::useR2018"
subtitle: "forecasting multiple seasonality with state switching"
author: "Mitchell O'Hara-Wild"
date: '13/07/2018'
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: ["libs/slides.css",  "libs/animate.css"]
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: inverse 

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE,
        width = 87)
library(tidyverse)
library(fasster)
library(knitr)
library(kableExtra)
library(lubridate)
library(tsibble)
library(ggplot2)
library(fontawesome)

opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.width = 12, fig.show = 'hold', 
  cache = TRUE, external = TRUE, dev = 'svglite', dev.args = list(bg = "transparent")
)


theme_set(
  theme_grey(base_size = 16) + 
  theme(
    legend.position = "bottom",
    plot.background = element_rect(fill = "transparent"),
    legend.background = element_rect(fill = "transparent")
  )
)
```

.title[fasster]
.sticker-float[![fasster](resources/fasster.png)]

## Forecasting multiple seasonality with state switching

.bottom[
### Mitchell O'Hara-Wild (`r fa("twitter", fill="#1da1f2")`[@mitchoharawild](https://twitter.com/mitchoharawild))
<br>
### 13 July 2018

### Slides @ [mitchelloharawild.com/useR18/](http://mitchelloharawild.com/useR18/)
]

---
class: center

.animated.fadeIn[
## Time-series data is changing

### More data, more often.

<hr>
]

---
class: center

## Time-series data is changing

### More data, more often.

<hr>

.animated.fadeIn[
## Complicated patterns emerge

.pull-left[
### Multiple seasonality
### Lots of data
]
.pull-right[
### Missing values
### Additional noise
]

<hr> 
]

---
class: center

## Time-series data is changing

### More data, more often.

<hr>

## Complicated patterns emerge

.pull-left[
### Multiple seasonality
### Lots of data
]
.pull-right[
### Missing values
### Additional noise
]

<hr> 

.animated.fadeIn[
## New tools are needed
.sticker[![tsibble](resources/tsibble.svg)]
.sticker[![fable](resources/fable.svg)]
.sticker[![fasster](resources/fasster.png)]
]

---
class: inverse, center, top

background-image: url(resources/electricity.jpg)
background-size: cover

.animated.fadeIn.shadowText[
# Electricity demand
]

---

# Electricity demand
```{r elecMonthly, cache = TRUE}
tsibbledata::elecdemand %>% 
  index_by(Time = yearmonth(index)) %>%
  summarise(Demand = sum(Demand)) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```

---

# Electricity demand
```{r elecDaily, cache = TRUE}
tsibbledata::elecdemand %>% 
  index_by(Time = as.Date(index)) %>%
  summarise(Demand = sum(Demand)) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```

---

# Electricity demand
```{r elecPlot, cache = TRUE}
tsibbledata::elecdemand %>% 
  rename(Time = index) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```
---


# Models for multiple seasonality
```{r, cache = TRUE}
library(timevis)
data <- data.frame(
  id      = 1:7,
  content = c("MSARIMA", "DSHW", "TBATS",
              "MLR", "GAM", "Prophet"),
  start   = c("1970", "2003", "2010",
              "2000", "1990", "2017"),
  group   = rep(c("ss", "reg"), each = 3),
  end     = rep(NA, 7)
)

grp <- data.frame(
  id = c("ss", "reg"),
  content = rep(c("State Space", "Regression"))
)

timevis(data, grp, showZoom = FALSE, options = list(zoomable=FALSE, showCurrentTime=FALSE), width = "100%", height = "250px")
```

<table class="table">
  <thead>
    <tr>
      <th>Model</th>
      <th>Flexible</th>
      <th>Speed</th>
      <th>Exogenous Regressors</th>
      <th>Accuracy</th>
      <th>Decompose Components</th>
      <th>Evolving Terms</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>State&nbspSpace</td>
      <td class="danger">No</td>
      <td class="danger">Slow</td>
      <td class="danger">No</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
    <tr>
      <td>Regression</td>
      <td class="success">Yes</td>
      <td class="success">Fast</td>
      <td class="success">Yes</td>
      <td class="warning">Okay</td>
      <td class="danger">No</td>
      <td class="danger">No</td>
    </tr>
  </tbody>
</table>

.center[(this table is a *massive* generalisation)]

---
class: inverse

.sticker-float[![fasster](resources/fasster.png)]
# What is fasster?

### * **F**orecasting with **A**dditive **S**witching of **S**easonality, **T**rend & **E**xogenous **R**egressors*

<br>

--

### A state space model that is:
.pull-left[
* ### Flexible
]
.pull-right[
* ### Fast
]

<br>

--

### With support for:

* ### Missing values
* ### Exogenous regressors

---


.sticker-float[![fable](resources/fable.svg)]

# Extending fable

**fasster** is the first extension of fable.

<br>

This allows fasster models to work with other features from the fable package.

* Consistent output and graphics
* Usable in combination forecasts

<br>

Uses formula based model specification:

.panel.panel-default[.panel-body.largecode[
t(y) ~ *\{specials\}*
]]

---

# Supported specials for fasster

```{r}
tribble(
  ~ Function, ~ Description,
  "poly(n)", "Polynomials",
  "seas(s)", "Seasonal factors",
  "trig(s, q)", "Seasonal fourier terms",
  "ARMA(ar, ma)", "ARMA processes",
  "%S%", "State switching",
  "xreg", "Exogenous regressors",
  "custom()", "Custom dlm matrices"
) %>% 
  kable(format = "html") %>%
  kableExtra::kable_styling(font_size = 26)
```

---

# Modelling with fasster

```{r elecPlot2, cache = TRUE}
tsibbledata::elecdemand %>%  
  rename(Time = index) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```

---

# Modelling with fasster

```{r electr, echo = TRUE, cache = TRUE}
elec_tr <- tsibbledata::elecdemand %>%
  filter(index < ymd("2014-03-01"))
```
```{r electr-print}
elec_tr
```


---

# Capturing seasonality
```{r, echo = TRUE, eval = FALSE}
y ~ poly(1) + trig(48, 16)
```


```{r noswitching, cache = TRUE}
tsibbledata::elecdemand %>% 
  filter(month(index) == 6) %>%
  ggplot(aes(x=index, y = Demand)) +
  geom_line() + 
  xlab("Time [30 MINUTES]") + 
  ylab("Electricity Demand (GW)")
```


---

# Capturing seasonality
```{r, echo = TRUE, eval = FALSE}
y ~ DayType %S% (poly(1) + trig(48, 16))
```


```{r switching, cache = TRUE}
tsibbledata::elecdemand %>% 
  filter(month(index) == 6) %>%
  mutate(
    `Working Day` = ifelse(WorkDay == 1, Demand, NA),
    `Non-working Day` = ifelse(WorkDay == 0, Demand, NA)
  ) %>%
  gather("Day Type", "Demand", `Working Day`, `Non-working Day`) %>%
  ggplot(aes(x=index, y = Demand, colour = `Day Type`)) +
  geom_line() + 
  xlab("Time [30 MINUTES]") + 
  ylab("Electricity Demand (GW)")
```

---

# Using temperature information

```{r, echo = TRUE, eval = FALSE}
y ~ Temperature + Temperature^2
# (huge simplification of the non-linear relationship)
```

```{r fig.height=5}
elec_tr %>%
  gather("Series", "Value", Demand, Temperature) %>%
  ggplot(aes(x=index, y=Value, group=Series)) +
  geom_line() +
  facet_grid(Series ~ ., scales = "free_y") + 
  ylab("Electricity demanded (GW)") + 
  xlab("Date") + 
  ggtitle("Electricity demanded and temperature")
```

* Strongly related non-linear relationship.
* Takes care of most annual seasonality.

---

# Estimating the model

```{r, elecfit, echo = TRUE, cache = TRUE}
elec_fit <- elec_tr %>%
  fasster(
    log(Demand) ~ 
      WorkDay %S% (trig(48, 16) + poly(1)) + 
      Temperature + Temperature^2
  )
```

* A log transformation is taken to normalise the variance.
* Specials are combined additively.

---

# Components

```{r elec-comp, echo = TRUE, cache = TRUE}
components(elec_fit)
```

---

# Components (Seasonality)

```{r comp-plot1, cache = FALSE}
fit_comp <- components(elec_fit)
fit_comp %>%
  select(index, `WorkDay_0/trig(48, 16)`, `WorkDay_1/trig(48, 16)`) %>% 
  gather("Term", "Value", -index) %>%
  ggplot(aes(x = hour(index) + minute(index)/60, y = Value, colour = Term, group = interaction(Term, date(index)))) + 
  geom_line() + 
  xlab("Hour")
```


---

# Forecasts

```{r}
elec_ts <- tsibbledata::elecdemand %>%
  tsibble::filter(
    index >= ymd("2014-03-01"),
    index < ymd("2014-04-01"))
```
```{r, echo = TRUE, eval = FALSE}
elec_ts
```
```{r}
elec_ts %>%
  select(-Demand)
```


---

# Forecasts

```{r elecfc, cache = TRUE, echo = TRUE}
elec_fc <- elec_fit %>% 
  forecast(newdata = elec_ts) 

elec_fc %>%
  autoplot()
```

---
# Forecasts
```{r}
elec_fc %>%
  autoplot(level = NULL) + 
  geom_line(aes(x=index, y=Demand), data=elec_ts)
```


---

# Interpolation

```{r elecmissing}
elecdemand_missing <- elec_tr
elecdemand_missing$Demand[elecdemand_missing$index >= ymd("2014-02-01") &
                          elecdemand_missing$index <  ymd("2014-02-14")] <- NA

elecdemand_missing %>%  
  rename(Time = index) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```

---

# Interpolation

```{r interpolated}
elecdemand_missing %>%
  fasster(log(Demand) ~ WorkDay %S% (trig(48, 16) + poly(1)) + 
                        Temperature + Temperature^2) %>%
  interpolate %>%
  autoplot(Demand)
```


---

# Interpolation

```{r interpolated-actual}
elec_tr %>%
  autoplot(Demand)
```

---

# Streaming data

```{r stream_data}
elec_tr %>% 
  autoplot(Demand) + 
  geom_line(aes(x = index, y = Demand, colour = "New streaming data"), data = head(elec_ts, 48*7))
```
---

```{r stream_fc, echo = TRUE}
elec_fit %>%
  stream(head(elec_ts, 48*7)) %>%
  forecast(tail(elec_ts, -48*7)) %>%
  autoplot + 
  ylab("Electricity Demand (GW)")
```


---
class: inverse, top

.sticker-float[![fasster](resources/fasster.png)]
<br>

# A fasster summary
<br>

Features:
.pull-left[
* Component extraction
* Forecasting
]
.pull-right[
* Interpolation
* Streaming
]

<br>

--

<table class="table">
  <thead>
    <tr>
      <th>Model</th>
      <th>Flexible</th>
      <th>Speed</th>
      <th>Exogenous Regressors</th>
      <th>Accuracy</th>
      <th>Decompose Components</th>
      <th>Evolving Terms</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BATS/TBATS</td>
      <td class="danger">No</td>
      <td class="danger">Slow</td>
      <td class="danger">No</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
    <tr>
      <td>Prophet</td>
      <td class="warning">Okay</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Good</td>
      <td class="success">Yes</td>
      <td class="danger">No</td>
    </tr>
    <tr>
      <td>fasster</td>
      <td class="success">Yes</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Good</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
  </tbody>
</table>

---

class: inverse, top

.sticker-float[![fasster](resources/fasster.png)]
<br>

# Try for yourself:

Learn more about fasster on GitHub:
`r fa("github", fill = "white")` [tidyverts/fasster](https://github.com/tidyverts/fasster)

Keep updated: 
`r fa("globe", fill = "white")` [tidyverts.org](http://www.tidyverts.org)

Review slides:
`r fa("desktop", fill = "white")` [mitchelloharawild.com/useR18/](http://mitchelloharawild.com/useR18/)