---
title: "fasster::useR2018"
subtitle: "forecasting multiple seasonality with state switching"
author: "Mitchell O'Hara-Wild"
date: '13/07/2018'
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: ["libs/slides.css",  "libs/animate.css"]
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: inverse 

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE,
        width = 87)
library(tidyverse)
library(fasster)
library(knitr)
library(kableExtra)
library(lubridate)
library(tsibble)
library(ggplot2)
library(fontawesome)

opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.width = 12, fig.show = 'hold', 
  cache = TRUE, external = TRUE, dev = 'svglite', dev.args = list(bg = "transparent")
)


theme_set(
  theme_grey(base_size = 16) + 
  theme(
    legend.position = "bottom",
    plot.background = element_rect(fill = "transparent"),
    legend.background = element_rect(fill = "transparent")
  )
)
```

.title[fasster]
.sticker-float[![fasster](resources/fasster.png)]

## Forecasting multiple seasonality with state switching

.bottom[
### Mitchell O'Hara-Wild (`r fa("twitter", fill="#1da1f2")`[@mitchoharawild](https://twitter.com/mitchoharawild))
<br>
### July 13th 2018

### Slides @ [mitchelloharawild.com/useR18/](http://mitchelloharawild.com/useR18/)
]

---
class: center

.animated.fadeIn[
## Time-series data is changing

### More data, more often.

<hr>
]

---
class: center

## Time-series data is changing

### More data, more often.

<hr>

.animated.fadeIn[
## Complicated patterns emerge

.pull-left[
### Multiple seasonality
### Lots of data
]
.pull-right[
### Missing values
### Additional noise
]

<hr> 
]

---
class: center

## Time-series data is changing

### More data, more often.

<hr>

## Complicated patterns emerge

.pull-left[
### Multiple seasonality
### Lots of data
]
.pull-right[
### Missing values
### Additional noise
]

<hr> 

.animated.fadeIn[
## New tools are needed
.sticker[![tsibble](resources/tsibble.svg)]
.sticker[![fable](resources/fable.svg)]
.sticker[![fasster](resources/fasster.png)]
]

---
class: inverse, center, top

background-image: url(resources/electricity.jpeg)
background-size: cover

# Electricity demand

---

# Electricity demand
```{r elecMonthly, cache = TRUE}
tsibbledata::elecdemand %>% 
  index_by(Time = yearmonth(index)) %>%
  summarise(Demand = sum(Demand)) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```

---

# Electricity demand
```{r elecDaily, cache = TRUE}
tsibbledata::elecdemand %>% 
  index_by(Time = as.Date(index)) %>%
  summarise(Demand = sum(Demand)) %>%
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```

---

# Electricity demand
```{r elecPlot, cache = TRUE}
tsibbledata::elecdemand %>% 
  autoplot(Demand) + 
  ylab("Electricity Demand (GW)")
```
---


# Models for multiple seasonality
```{r, cache = TRUE}
library(timevis)
data <- data.frame(
  id      = 1:7,
  content = c("MSARIMA", "DSHW", "BATS/TBATS", "FASSTER",
              "MLR", "GAM", "Prophet"),
  start   = c("2000", "2003", "2010", "2018",
              "2000", "2000", "2017"),
  group   = c("ss", rep(c("ss", "reg"), each = 3)),
  end     = rep(NA, 7)
)

grp <- data.frame(
  id = c("ss", "reg"),
  content = rep(c("State Space", "Regression"))
)

timevis(data, grp, showZoom = FALSE, options = list(zoomable=FALSE, showCurrentTime=FALSE), width = "100%", height = "250px")
```

<table class="table">
  <thead>
    <tr>
      <th>Model</th>
      <th>Flexible</th>
      <th>Speed</th>
      <th>Exogenous Regressors</th>
      <th>Accuracy</th>
      <th>Decompose Components</th>
      <th>Evolving Terms</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>State&nbspSpace</td>
      <td class="danger">No</td>
      <td class="danger">Slow</td>
      <td class="danger">No</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
    <tr>
      <td>Regression</td>
      <td class="success">Yes</td>
      <td class="success">Fast</td>
      <td class="success">Yes</td>
      <td class="warning">Okay</td>
      <td class="danger">No</td>
      <td class="danger">No</td>
    </tr>
  </tbody>
</table>

.center[(this table is a *massive* generalisation)]

---
class: inverse

.sticker-float[![fasster](resources/fasster.png)]
# What is fasster?

### * **F**orecasting with **A**dditive **S**witching of **S**easonality, **T**rend & **E**xogenous **R**egressors*

<br> <br> 

### A state space model that is:
.pull-left[
* ### Flexible
* ### Fast
]
.pull-right[
* ### Supports exogenous regressors
* ### Handles missing values
]
---

.sticker-float[![fable](resources/fable.svg)]

# Extending fable

**fasster** objects are consistent with the **fable** package.

Which provides:

- Plotting of forecasts and components
- Model extraction methods
- Accuracy measures
- Residual diagnostics

---

# Flexible model specification
```{r, echo = TRUE, eval = FALSE}
log(y + 1) ~ poly(1) + seas(24) + trig(24*365.25, 10) + x + z^2
```

### poly(n): Polynomials
### seas(s): Seasonal factors
### trig(s, q): Seasonal fourier terms
### ARMA(ar, ma): ARMA processes
### xreg: Exogenous regressors

---

# %S%: State switching
```{r, echo = TRUE, eval = FALSE}
y ~ DayType %S% (poly(1) + trig(48, 14))
```


```{r switching, cache = TRUE}
tsibbledata::elecdemand %>% 
  filter(month(index) == 6) %>%
  mutate(
    `Working Day` = ifelse(WorkDay == 1, Demand, NA),
    `Non-working Day` = ifelse(WorkDay == 0, Demand, NA)
  ) %>%
  gather("Day Type", "Demand", `Working Day`, `Non-working Day`) %>%
  ggplot(aes(x=index, y = Demand, colour = `Day Type`)) +
  geom_line() + 
  xlab("Time [30 MINUTES]") + 
  ylab("Electricity Demand (GW)") + 
  theme(legend.position = "bottom")
```


---

# Modelling electricity demand

```{r electr, echo = TRUE, cache = TRUE}
elec_tr <- tsibbledata::elecdemand %>%
  filter(index < ymd("2014-03-01"))
elec_tr
```

---

# Modelling electricity demand

```{r}
elec_tr %>%
  gather("Series", "Value", Demand, Temperature) %>%
  ggplot(aes(x=index, y=Value, group=Series)) +
  geom_line() +
  facet_grid(Series ~ ., scales = "free_y") + 
  ylab("Electricity demanded (GW)") + 
  xlab("Date") + 
  ggtitle("Electricity demanded and temperature")
```


---

```{r, elecfit, echo = TRUE, cache = TRUE}
elec_fit <- elec_tr %>%
  fasster(log(Demand) ~ WorkDay %S% (trig(48, 16) + poly(1)) + 
                        Temperature + Temperature^2)
elec_fit
```


---

# Components

```{r elec-comp, echo = TRUE, cache = TRUE}
components(elec_fit)
```

---

# Components (Seasonality)

```{r comp-plot1, cache = FALSE}
fit_comp <- components(elec_fit)
fit_comp %>%
  select(index, `WorkDay_0/trig(48, 16)`, `WorkDay_1/trig(48, 16)`) %>% 
  gather("Term", "Value", -index) %>%
  ggplot(aes(x = hour(index) + minute(index)/60, y = Value, colour = Term, group = interaction(Term, date(index)))) + 
  geom_line() + 
  xlab("Hour")
```


---

# Forecasts (Electricity demand)

```{r elecfc, cache = TRUE}
elec_ts <- tsibbledata::elecdemand %>%
  tsibble::filter(index >= ymd("2014-03-01")) %>%
  head(48*7*3)

elec_fc <- elec_fit %>% 
  forecast(newdata = elec_ts) 

elec_fc %>%
  autoplot(level = NULL) + 
  geom_line(aes(x=index, y=Demand), data=elec_ts)
```


---

# Interpolation

Insert missing value plots here, filled with fasster modelled fits
Visually compare with actual values

---

# Streaming data

Mention that new data can come in without refitting the model

```{r stream_data, echo = TRUE}
elec_tr %>% 
  mutate()
```
```{r}
elec_fit %>%
  stream(elec_ts)
```


---
class: inverse, top

.sticker-float[![fasster](resources/fasster.png)]
<br>
.center[
# The fasster package
]


<table class="table">
  <thead>
    <tr>
      <th>Model</th>
      <th>Flexible</th>
      <th>Speed</th>
      <th>Exogenous Regressors</th>
      <th>Accuracy</th>
      <th>Decompose Components</th>
      <th>Evolving Terms</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>State&nbspSpace</td>
      <td class="danger">No</td>
      <td class="danger">Slow</td>
      <td class="danger">No</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
    <tr>
      <td>Regression</td>
      <td class="success">Yes</td>
      <td class="success">Fast</td>
      <td class="success">Yes</td>
      <td class="warning">Okay</td>
      <td class="danger">No</td>
      <td class="danger">No</td>
    </tr>
    <tr>
      <td>fasster</td>
      <td class="success">No</td>
      <td class="warning">Okay*</td>
      <td class="success">No</td>
      <td class="warning">Okay</td>
      <td class="success">Yes</td>
      <td class="success">Yes</td>
    </tr>
  </tbody>
</table>

.footnote[[*] Much faster than state space models, similar speed to prophet]

The **development** version can be installed from GitHub using:

```{r, echo = TRUE, eval = FALSE}
# install.packages("devtools")
devtools::install_github("mitchelloharawild/fasster")
```